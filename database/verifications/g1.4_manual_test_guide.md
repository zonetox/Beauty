# G1.4 - Auth & RLS Manual Testing Guide

**M·ª•c ƒë√≠ch:** H∆∞·ªõng d·∫´n test RLS policies v·ªõi c√°c roles th·ª±c t·∫ø

---

## üìã CHU·∫®N B·ªä

### 1. T·∫°o Test Users trong Supabase Auth

**C√°ch t·∫°o:**
1. V√†o Supabase Dashboard ‚Üí Authentication ‚Üí Users
2. T·∫°o c√°c users sau:

**Test User (Regular):**
- Email: `test-user@1beauty.asia`
- Password: `TestUser123!`
- Role: Regular user (kh√¥ng c√≥ business)

**Test Business Owner:**
- Email: `test-owner@1beauty.asia`
- Password: `TestOwner123!`
- Role: Business owner (c·∫ßn link v·ªõi business)

**Test Admin:**
- Email: `test-admin@1beauty.asia`
- Password: `TestAdmin123!`
- Role: Admin (c·∫ßn t·∫°o record trong `admin_users` table)

### 2. Setup Test Data

**T·∫°o test business:**
```sql
-- Ch·∫°y v·ªõi service role ho·∫∑c admin
INSERT INTO businesses (
    name, slug, address, city, phone, email,
    is_active, is_verified, owner_id
) VALUES (
    'Test Business',
    'test-business',
    '123 Test St',
    'Ho Chi Minh',
    '0123456789',
    'test-owner@1beauty.asia',
    true,
    true,
    (SELECT id FROM auth.users WHERE email = 'test-owner@1beauty.asia')
) RETURNING id;
```

**T·∫°o admin user:**
```sql
-- Ch·∫°y v·ªõi service role ho·∫∑c admin
INSERT INTO admin_users (
    username, email, role, permissions, is_locked
) VALUES (
    'test-admin',
    'test-admin@1beauty.asia',
    'Admin',
    '{
        "canViewAnalytics": true,
        "canManageBusinesses": true,
        "canManageRegistrations": true,
        "canManageOrders": true,
        "canManagePlatformBlog": true,
        "canManageUsers": true,
        "canManagePackages": true,
        "canManageAnnouncements": true,
        "canManageSupportTickets": true,
        "canManageSiteContent": true,
        "canManageSystemSettings": true,
        "canUseAdminTools": true,
        "canViewActivityLog": true,
        "canViewEmailLog": true
    }'::jsonb,
    false
);
```

---

## üß™ TEST CASES

### Test 1: Anonymous User

**M·ª•c ti√™u:** Verify anonymous users ch·ªâ th·∫•y public data

**Test steps:**
1. Logout (ho·∫∑c d√πng incognito)
2. Truy c·∫≠p `/directory`
3. Verify: Ch·ªâ th·∫•y businesses c√≥ `is_active = true`
4. Th·ª≠ truy c·∫≠p `/account` ‚Üí Should redirect to `/login`
5. Th·ª≠ truy c·∫≠p `/admin` ‚Üí Should redirect to `/admin/login`

**Expected results:**
- ‚úÖ C√≥ th·ªÉ xem active businesses
- ‚úÖ C√≥ th·ªÉ xem blog posts
- ‚ùå Kh√¥ng th·ªÉ truy c·∫≠p protected routes
- ‚ùå Kh√¥ng th·ªÉ th·∫•y inactive businesses

---

### Test 2: Regular User

**M·ª•c ti√™u:** Verify regular users c√≥ quy·ªÅn ƒë√∫ng

**Test steps:**
1. Login v·ªõi `test-user@1beauty.asia`
2. Truy c·∫≠p `/directory`
3. Verify: C√≥ th·ªÉ xem active businesses
4. Th·ª≠ t·∫°o review cho m·ªôt business
5. Th·ª≠ truy c·∫≠p `/account` ‚Üí Should show onboarding wizard (no business)
6. Th·ª≠ truy c·∫≠p `/admin` ‚Üí Should redirect to `/admin/login`

**Expected results:**
- ‚úÖ C√≥ th·ªÉ xem active businesses
- ‚úÖ C√≥ th·ªÉ t·∫°o reviews
- ‚úÖ C√≥ th·ªÉ truy c·∫≠p `/account` (onboarding wizard)
- ‚ùå Kh√¥ng th·ªÉ truy c·∫≠p admin panel
- ‚ùå Kh√¥ng th·ªÉ CRUD business data

---

### Test 3: Business Owner

**M·ª•c ti√™u:** Verify business owners ch·ªâ th·∫•y/modify data c·ªßa m√¨nh

**Test steps:**
1. Login v·ªõi `test-owner@1beauty.asia`
2. Truy c·∫≠p `/account` ‚Üí Should show business dashboard
3. Verify: Ch·ªâ th·∫•y business c·ªßa m√¨nh
4. Th·ª≠ CRUD services ‚Üí Should work
5. Th·ª≠ CRUD deals ‚Üí Should work
6. Th·ª≠ CRUD blog posts ‚Üí Should work
7. Th·ª≠ truy c·∫≠p business kh√°c (n·∫øu c√≥) ‚Üí Should not see data

**Expected results:**
- ‚úÖ C√≥ th·ªÉ CRUD own business data
- ‚úÖ C√≥ th·ªÉ CRUD own services, deals, blog posts
- ‚ùå Kh√¥ng th·ªÉ th·∫•y data c·ªßa business kh√°c
- ‚ùå Kh√¥ng th·ªÉ truy c·∫≠p admin panel

**SQL Test (ch·∫°y v·ªõi business owner context):**
```sql
-- Set user context (gi·∫£ l·∫≠p)
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claim.sub = (SELECT id::text FROM auth.users WHERE email = 'test-owner@1beauty.asia');

-- Test: Ch·ªâ th·∫•y business c·ªßa m√¨nh
SELECT * FROM businesses WHERE owner_id = auth.uid();
-- Should return only own business

-- Test: Kh√¥ng th·∫•y business c·ªßa ng∆∞·ªùi kh√°c
SELECT * FROM businesses WHERE owner_id != auth.uid();
-- Should return empty (RLS blocks)
```

---

### Test 4: Admin User

**M·ª•c ti√™u:** Verify admin c√≥ full access

**Test steps:**
1. Login v·ªõi `test-admin@1beauty.asia` t·∫°i `/admin/login`
2. Truy c·∫≠p `/admin`
3. Verify: C√≥ th·ªÉ xem t·∫•t c·∫£ businesses
4. Th·ª≠ CRUD businesses ‚Üí Should work
5. Th·ª≠ CRUD admin users ‚Üí Should work
6. Th·ª≠ CRUD blog posts ‚Üí Should work

**Expected results:**
- ‚úÖ C√≥ th·ªÉ xem t·∫•t c·∫£ businesses
- ‚úÖ C√≥ th·ªÉ CRUD businesses
- ‚úÖ C√≥ th·ªÉ CRUD admin users
- ‚úÖ C√≥ th·ªÉ CRUD blog posts
- ‚úÖ C√≥ th·ªÉ approve registration requests

**SQL Test (ch·∫°y v·ªõi admin context):**
```sql
-- Set admin context
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claim.email = 'test-admin@1beauty.asia';

-- Test: C√≥ th·ªÉ SELECT t·∫•t c·∫£ businesses
SELECT COUNT(*) FROM businesses;
-- Should return all businesses

-- Test: C√≥ th·ªÉ DELETE businesses
DELETE FROM businesses WHERE id = <test_business_id>;
-- Should work (n·∫øu c√≥ permission)
```

---

### Test 5: Cross-Tenant Protection

**M·ª•c ti√™u:** Verify business owners kh√¥ng th·ªÉ access data c·ªßa business kh√°c

**Test steps:**
1. T·∫°o 2 businesses v·ªõi 2 owners kh√°c nhau
2. Login v·ªõi owner 1
3. Th·ª≠ SELECT business c·ªßa owner 2 ‚Üí Should fail (RLS blocks)
4. Th·ª≠ UPDATE business c·ªßa owner 2 ‚Üí Should fail
5. Th·ª≠ DELETE business c·ªßa owner 2 ‚Üí Should fail

**SQL Test:**
```sql
-- Setup: T·∫°o 2 businesses
-- Business 1: owner_id = user1_id
-- Business 2: owner_id = user2_id

-- Test v·ªõi user1 context
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claim.sub = user1_id::text;

-- Test: Ch·ªâ th·∫•y business c·ªßa m√¨nh
SELECT * FROM businesses;
-- Should return only business 1

-- Test: Kh√¥ng th·ªÉ UPDATE business c·ªßa ng∆∞·ªùi kh√°c
UPDATE businesses SET name = 'Hacked' WHERE owner_id = user2_id;
-- Should fail (RLS blocks)

-- Test: Kh√¥ng th·ªÉ DELETE business c·ªßa ng∆∞·ªùi kh√°c
DELETE FROM businesses WHERE owner_id = user2_id;
-- Should fail (RLS blocks)
```

---

### Test 6: Unauthorized Access

**M·ª•c ti√™u:** Verify unauthorized access b·ªã block

**Test steps:**
1. Anonymous user th·ª≠ INSERT business ‚Üí Should fail
2. Regular user th·ª≠ DELETE business ‚Üí Should fail
3. Business owner th·ª≠ DELETE business ‚Üí Should fail (ch·ªâ admin m·ªõi ƒë∆∞·ª£c)
4. Regular user th·ª≠ INSERT v√†o admin_users ‚Üí Should fail

**SQL Test:**
```sql
-- Test v·ªõi anonymous context
SET LOCAL ROLE anon;

-- Test: Kh√¥ng th·ªÉ INSERT business
INSERT INTO businesses (name, slug) VALUES ('Hacked', 'hacked');
-- Should fail (RLS blocks)

-- Test v·ªõi regular user context
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claim.sub = regular_user_id::text;

-- Test: Kh√¥ng th·ªÉ DELETE business
DELETE FROM businesses WHERE id = 1;
-- Should fail (RLS blocks)

-- Test: Kh√¥ng th·ªÉ INSERT v√†o admin_users
INSERT INTO admin_users (username, email) VALUES ('hacker', 'hacker@test.com');
-- Should fail (RLS blocks)
```

---

## ‚úÖ VERIFICATION CHECKLIST

- [ ] Anonymous users ch·ªâ th·∫•y active businesses
- [ ] Regular users c√≥ th·ªÉ t·∫°o reviews
- [ ] Business owners ch·ªâ th·∫•y/modify own business data
- [ ] Business owners kh√¥ng th·ªÉ access data c·ªßa business kh√°c
- [ ] Admin c√≥ full access
- [ ] Unauthorized access b·ªã block
- [ ] Cross-tenant protection ho·∫°t ƒë·ªông
- [ ] Sensitive tables (admin_users, app_settings) ch·ªâ admin access

---

## üìù NOTES

1. **RLS Policies ƒë∆∞·ª£c test ·ªü database level**, kh√¥ng ph·∫£i frontend level
2. **Frontend guards** (ProtectedRoute, PermissionGuard) l√† l·ªõp b·∫£o v·ªá th·ª© 2
3. **RLS l√† single source of truth** cho security
4. N·∫øu RLS test pass nh∆∞ng frontend v·∫´n c√≥ th·ªÉ access ‚Üí Check frontend guards

---

**Last Updated:** 2025-01-06






