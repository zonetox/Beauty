# C3.3 – Landing Page Builder Audit Report (Step 1)

**Version:** 1.0  
**Date:** 2025-01-05  
**Status:** ✅ AUDIT COMPLETE

---

## EXECUTIVE SUMMARY

Audit hiện trạng public business landing page để xác định data sources, render logic, và khả năng chỉnh sửa. **KHÔNG phát hiện nguy cơ tạo hệ thống song song**. Tất cả data đã có trong schema hiện có, có thể implement editor mà không cần tạo schema/table mới.

---

## 1. PUBLIC BUSINESS PAGE RENDER

### 1.1 Page Component

**File:** `pages/BusinessDetailPage.tsx`  
**Route:** `/business/:slug`  
**Layout:** Custom (NO AppLayout - standalone landing page)

**Data Fetching:**
```typescript
const { fetchBusinessBySlug, incrementBusinessViewCount } = useBusinessData();
const data = await fetchBusinessBySlug(slug);
```

**Data Source:**
- `BusinessDataContext.fetchBusinessBySlug(slug)`
- Queries: `businesses` table + related tables (services, deals, media_items, team_members, reviews, business_blog_posts)
- RLS enforced: Public can read active businesses

### 1.2 Section Components

**Location:** `components/business-landing/`

**Sections (in order):**
1. `BusinessHeader` - Header với logo, nav
2. `HeroSection` - Hero slides với title, subtitle, CTA
3. `AboutSection` - About/Description section
4. `ServicesSection` - Services preview (link tới Services)
5. `GallerySection` - Gallery images/videos
6. `TeamSection` - Team members
7. `VideoSection` - YouTube video
8. `BusinessBlogSection` - Business blog posts
9. `DealsSection` - Active deals
10. `ReviewsSection` - Reviews
11. `BookingCtaSection` - CTA block (static content)
12. `LocationSection` - Map & location
13. `BusinessFooter` - Footer

---

## 2. DATA SOURCES ANALYSIS

### 2.1 Hero Section

**Component:** `components/business-landing/HeroSection.tsx`

**Data Source:**
- Primary: `business.heroSlides` (JSONB array)
  - Format: `[{ title: string, subtitle: string, imageUrl: string }]`
- Fallback (if no heroSlides):
  - `title`: `business.name`
  - `subtitle`: `business.slogan || business.categories.join(', ')`
  - `imageUrl`: `business.heroImageUrl || business.imageUrl`

**Schema Fields:**
- `hero_slides` (JSONB) - ✅ Đã có trong schema
- `hero_image_url` (TEXT) - ✅ Đã có trong schema
- `slogan` (TEXT) - ✅ Đã có trong schema
- `name` (TEXT) - ✅ Đã có trong schema
- `image_url` (TEXT) - ✅ Đã có trong schema

**Editable Fields:**
- ✅ `hero_slides` - Array of slides (title, subtitle, imageUrl)
- ✅ `hero_image_url` - Fallback hero image
- ✅ `slogan` - Fallback subtitle

**LocalStorage/Fallback:**
- ❌ Không có localStorage fallback
- ✅ Data từ database only

### 2.2 About Section

**Component:** `components/business-landing/AboutSection.tsx`

**Data Source:**
- `business.description` (TEXT)
- `business.imageUrl` (TEXT) - Cover image

**Schema Fields:**
- `description` (TEXT) - ✅ Đã có trong schema
- `image_url` (TEXT) - ✅ Đã có trong schema

**Editable Fields:**
- ✅ `description` - About/Description text
- ✅ `image_url` - Cover image (đã có trong C3.2)

**LocalStorage/Fallback:**
- ❌ Không có localStorage fallback
- ✅ Data từ database only

### 2.3 Services Section

**Component:** `components/business-landing/ServicesSection.tsx`

**Data Source:**
- `business.services` - Array from `services` table
- Linked via: `services.business_id = businesses.id`
- RLS: Public can read active services

**Schema Fields:**
- `services` table - ✅ Đã có trong schema
  - `business_id` (FK to businesses)
  - `name`, `price`, `description`, `image_url`, `duration_minutes`, `position`

**Editable Fields:**
- ⚠️ Services được quản lý ở tab riêng (C3.4 - Services)
- ✅ Section này chỉ preview, link tới Services tab

**LocalStorage/Fallback:**
- ❌ Không có localStorage fallback
- ✅ Data từ database only

### 2.4 Gallery Section

**Component:** `components/business-landing/GallerySection.tsx`

**Data Source:**
- `business.gallery` - Array from `media_items` table
- Linked via: `media_items.business_id = businesses.id`
- RLS: Public can read media items

**Schema Fields:**
- `media_items` table - ✅ Đã có trong schema
  - `business_id` (FK to businesses)
  - `url`, `type`, `category`, `title`, `description`, `position`

**Editable Fields:**
- ⚠️ Gallery được quản lý ở tab riêng (C3.6 - Media)
- ✅ Section này chỉ display gallery

**LocalStorage/Fallback:**
- ❌ Không có localStorage fallback
- ✅ Data từ database only

### 2.5 Booking CTA Section

**Component:** `components/business-landing/BookingCtaSection.tsx`

**Data Source:**
- ❌ **Static content** - Không có data từ business
- Content: Hardcoded text "Sẵn sàng trải nghiệm dịch vụ đẳng cấp?"

**Editable Fields:**
- ⚠️ **CẦN QUYẾT ĐỊNH:** Có cho phép edit CTA text không?
- Option 1: Thêm field `cta_text` vào `businesses` table (cần schema change - KHÔNG được phép)
- Option 2: Dùng `slogan` hoặc field hiện có
- Option 3: Giữ static (không edit)

**Recommendation:** Giữ static hoặc dùng `slogan` field hiện có

**LocalStorage/Fallback:**
- ❌ Không có localStorage fallback
- ✅ Static content

---

## 3. DATA STRATEGY

### 3.1 Single Source of Truth

**Primary Table:** `businesses`

**Fields liên quan đến Landing Page:**
- `hero_slides` (JSONB) - Hero slides array
- `hero_image_url` (TEXT) - Fallback hero image
- `slogan` (TEXT) - Subtitle/CTA text
- `description` (TEXT) - About section
- `image_url` (TEXT) - Cover image (About section)
- `name` (TEXT) - Business name (Hero fallback)

**Related Tables (read-only trong editor):**
- `services` - Services preview (managed in C3.4)
- `media_items` - Gallery (managed in C3.6)

### 3.2 Data Storage

**Hero Slides:**
- Format: `[{ title: string, subtitle: string, imageUrl: string }]`
- Storage: `businesses.hero_slides` (JSONB)
- ✅ Đã có trong schema

**About/Description:**
- Storage: `businesses.description` (TEXT)
- ✅ Đã có trong schema

**Cover Image:**
- Storage: `businesses.image_url` (TEXT)
- ✅ Đã có trong schema (đã edit trong C3.2)

### 3.3 No LocalStorage Fallback

**Finding:**
- ✅ Không có localStorage fallback cho business landing page content
- ✅ Tất cả data từ database
- ✅ Không có nguy cơ data inconsistency

---

## 4. EDITABLE SECTIONS (C3.3 SCOPE)

### 4.1 Hero Section

**Editable:**
- ✅ Hero slides (array)
  - Title per slide
  - Subtitle per slide
  - Image URL per slide
- ✅ Hero image URL (fallback)
- ✅ Slogan (fallback subtitle)

**Data Fields:**
- `hero_slides` (JSONB)
- `hero_image_url` (TEXT)
- `slogan` (TEXT)

### 4.2 About Section

**Editable:**
- ✅ Description text
- ✅ Cover image (đã có trong C3.2)

**Data Fields:**
- `description` (TEXT)
- `image_url` (TEXT)

### 4.3 Services Section

**Editable:**
- ❌ **NOT IN SCOPE** - Services managed in C3.4
- ✅ Section chỉ preview, link tới Services tab

### 4.4 Gallery Section

**Editable:**
- ❌ **NOT IN SCOPE** - Gallery managed in C3.6
- ✅ Section chỉ display gallery

### 4.5 Booking CTA Section

**Editable:**
- ⚠️ **CẦN QUYẾT ĐỊNH** - Static content hiện tại
- Option: Dùng `slogan` field hoặc giữ static

---

## 5. RISK ASSESSMENT

### 5.1 No Parallel Systems Risk

**Finding:** ✅ **KHÔNG PHÁT HIỆN NGUY CƠ**

**Reasons:**
- ✅ Tất cả data từ `businesses` table (single source of truth)
- ✅ Không có localStorage fallback
- ✅ Không có duplicate data storage
- ✅ Public page render từ cùng data source

### 5.2 Schema Changes Required

**Finding:** ✅ **KHÔNG CẦN SCHEMA CHANGES**

**Reasons:**
- ✅ `hero_slides` (JSONB) - ✅ Đã có
- ✅ `hero_image_url` (TEXT) - ✅ Đã có
- ✅ `slogan` (TEXT) - ✅ Đã có
- ✅ `description` (TEXT) - ✅ Đã có
- ✅ `image_url` (TEXT) - ✅ Đã có

### 5.3 Breaking Changes Risk

**Finding:** ✅ **LOW RISK**

**Reasons:**
- ✅ Editor chỉ update existing fields
- ✅ Public page render logic không đổi
- ✅ Data format không đổi
- ✅ RLS policies không đổi

---

## 6. MAPPING: UI SECTION → DATA FIELD

### 6.1 Hero Section

| UI Element | Data Field | Type | Editable |
|------------|------------|------|----------|
| Slide Title | `hero_slides[].title` | string | ✅ Yes |
| Slide Subtitle | `hero_slides[].subtitle` | string | ✅ Yes |
| Slide Image | `hero_slides[].imageUrl` | string | ✅ Yes |
| Fallback Hero Image | `hero_image_url` | TEXT | ✅ Yes |
| Fallback Subtitle | `slogan` | TEXT | ✅ Yes |

### 6.2 About Section

| UI Element | Data Field | Type | Editable |
|------------|------------|------|----------|
| Description Text | `description` | TEXT | ✅ Yes |
| Cover Image | `image_url` | TEXT | ✅ Yes (C3.2) |

### 6.3 Services Section

| UI Element | Data Field | Type | Editable |
|------------|------------|------|----------|
| Services List | `services[]` | Table | ❌ No (C3.4) |
| Link to Services | N/A | N/A | ✅ Preview only |

### 6.4 Gallery Section

| UI Element | Data Field | Type | Editable |
|------------|------------|------|----------|
| Gallery Items | `gallery[]` | Table | ❌ No (C3.6) |
| Display Gallery | N/A | N/A | ✅ Display only |

### 6.5 Booking CTA Section

| UI Element | Data Field | Type | Editable |
|------------|------------|------|----------|
| CTA Text | Static | N/A | ⚠️ TBD |
| CTA Button | Static | N/A | ⚠️ TBD |

---

## 7. RECOMMENDATIONS

### 7.1 Editor Scope (C3.3)

**Editable Sections:**
1. ✅ **Hero Section**
   - Hero slides (add/edit/remove/reorder)
   - Hero image URL (fallback)
   - Slogan (fallback subtitle)

2. ✅ **About Section**
   - Description text
   - Cover image (link to C3.2 Media tab)

3. ❌ **Services Section**
   - Preview only, link to Services tab (C3.4)

4. ❌ **Gallery Section**
   - Display only, link to Gallery tab (C3.6)

5. ⚠️ **Booking CTA Section**
   - Option: Keep static OR use `slogan` field

### 7.2 Data Storage

**Single Source of Truth:**
- ✅ `businesses` table
- ✅ No new tables needed
- ✅ No schema changes needed

**Update Method:**
- ✅ Use `updateBusiness()` from `BusinessDataContext`
- ✅ Converts camelCase to snake_case automatically
- ✅ RLS enforced (business owner only)

### 7.3 Editor Implementation

**Component Name:**
- `BusinessLandingPageEditor.tsx` (hoặc `LandingPageEditor.tsx`)

**Tabs/Sections:**
1. Hero Section Editor
2. About Section Editor
3. Preview (optional)

**Features:**
- ✅ Form fields for editable content
- ✅ Image upload for hero slides (business-gallery bucket)
- ✅ Add/edit/remove/reorder hero slides
- ✅ Preview logic (optional)
- ✅ LoadingState, EmptyState, Error handling
- ✅ Save with toast feedback

---

## 8. CONCLUSION

### 8.1 Safe to Proceed

✅ **CÓ THỂ TRIỂN KHAI C3.3**

**Reasons:**
- ✅ Không cần schema changes
- ✅ Không cần table mới
- ✅ Không có nguy cơ tạo hệ thống song song
- ✅ Single source of truth rõ ràng
- ✅ Data fields đã có trong schema

### 8.2 Next Steps

**Step 2:** Thiết kế Editor (KHÔNG code)
- Map UI sections → form fields
- Design editor layout
- Confirm data flow

**Step 3:** Implement C3.3
- Create `BusinessLandingPageEditor.tsx`
- Implement hero slides editor
- Implement about section editor
- Add validation, error handling, loading states

**Step 4:** Verification
- Owner edit → public page update
- Reload/logout/cross-device OK
- No console errors
- No regression

**Step 5:** Completion Report

---

**Audit Status:** ✅ COMPLETE  
**Risk Level:** ✅ LOW  
**Schema Changes Required:** ❌ NO  
**Parallel Systems Risk:** ❌ NO  
**Ready for Step 2:** ✅ YES

